// Prisma schema for Spotli Agents Service
// This service shares the same database as spotli-mvp

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Agent configuration for an organization
model Agent {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  description    String?
  personality    String   @default("professional")
  tone           String   @default("friendly")
  language       String   @default("es")
  systemPrompt   String?  @map("system_prompt")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  conversations Conversation[]

  @@map("agents")
}

// Conversation thread
model Conversation {
  id             String    @id @default(uuid())
  agentId        String    @map("agent_id")
  userId         String    @map("user_id")
  organizationId String    @map("organization_id")
  title          String?
  status         String    @default("active") // active, archived, closed
  metadata       Json?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  closedAt       DateTime? @map("closed_at")

  // Relations
  agent    Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId])
  @@index([organizationId])
  @@index([agentId])
  @@map("conversations")
}

// Individual message in a conversation
model Message {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  role           String   // user, assistant, system
  content        String
  metadata       Json?    // token count, model used, latency, etc.
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}

// Rate limiting tracking
model RateLimitEntry {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  userId         String?  @map("user_id")
  endpoint       String
  count          Int      @default(1)
  windowStart    DateTime @map("window_start")
  createdAt      DateTime @default(now()) @map("created_at")

  @@unique([organizationId, userId, endpoint, windowStart])
  @@index([organizationId])
  @@map("rate_limit_entries")
}
